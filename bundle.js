(()=>{"use strict";window.const={INDEX_MIN:0,NOT_VALID_REPORT:"Количество гостей больше, чем количество комнат",MOUSE_BUTTON:1},(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;window.util={getRandomInRange:e,getRandomElement:t=>t[[e(0,t.length-1)]],mixArray:t=>{for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[o],t[o]=n}return t.splice(window.const.INDEX_MIN,e(window.const.INDEX_MIN,t.length-1)),t},makeElement:(e,t)=>{const o=document.createElement(e);return o.classList.add(t),o},findAdress:e=>`${parseInt(e.style.left,10)+33}, ${parseInt(e.style.top,10)+65}`,addShutdown:(e,t)=>{e.forEach((e=>{e.disabled=t}))}}})(),window.debounce=e=>{let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector(".map__pins");window.upload=(n,r)=>{const a=new XMLHttpRequest;a.responseType="json";const d=e=>{e.remove()};a.addEventListener("load",(()=>{if(r(a.response),200===a.status){const t=e.cloneNode(!0);o.appendChild(t),t.addEventListener("click",(()=>{d(t)})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),d(t))}))}else{const e=t.cloneNode(!0);o.appendChild(e),e.addEventListener("click",(()=>{d(e)})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&(t.preventDefault(),d(e))}))}})),a.open("GET","https://21.javascript.pages.academy/keksobooking/data"),a.send(n)}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__filters-container"),o=document.querySelector(".map");window.pin={renderPin:n=>{const r=e.cloneNode(!0);return r.querySelector("img").src=n.author.avatar,r.querySelector("img").alt=n.offer.title,r.style.left=n.location.x+"px",r.style.top=n.location.y+"px",r.addEventListener("click",(function(){o.insertBefore(window.advert.renderAdvert(n),t)})),r},deleteMarks:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove()))},renderPins:e=>{const t=document.createDocumentFragment(),o=document.querySelector(".map__pins"),n=e.length>=5?5:e.length;for(let o=0;o<n;o++)t.appendChild(window.pin.renderPin(e[o]));o.appendChild(t)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector("#popup__img").content.querySelector(".popup__photo");window.advert={renderAdvert:o=>{const n=e.cloneNode(!0),r=n.querySelector(".popup__photos"),a=document.querySelector(".map__card");a&&a.remove(),n.querySelector(".popup__avatar").src=o.author.avatar,n.querySelector(".popup__title").alt=o.offer.title,n.querySelector(".popup__text--address").textContent=o.offer.address,n.querySelector(".popup__text--price").textContent=`${o.offer.price} ₽/ночь`,"palace"===o.offer.type?n.querySelector(".popup__type").textContent="Дворец":"flat"===o.offer.type?n.querySelector(".popup__type").textContent="Квартира":"bungalo"===o.offer.type?n.querySelector(".popup__type").textContent="Бунгало":"bungalo"===o.offer.type&&(n.querySelector(".popup__type").textContent="Дом"),n.querySelector(".popup__text--capacity").textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${o.offer.checkin}, и выезд до ${o.offer.checkout}`;const d=n.querySelector(".popup__features");return n.querySelectorAll(".popup__feature").forEach((e=>e.parentNode.removeChild(e))),o.offer.features.forEach((e=>{const t=window.util.makeElement("li","popup__feature");t.classList.add(`popup__feature--${e}`),d.appendChild(t)})),n.querySelector(".popup__description").textContent=o.offer.desccription,o.offer.photos.forEach((e=>{const o=t.cloneNode(!0);o.src=e,r.appendChild(o)})),n.querySelector(".popup__close").addEventListener("click",(function(){n.remove()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),n.remove())})),n}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelectorAll(".map__filter"),o=document.querySelector(".ad-form-header"),n=document.querySelectorAll(".ad-form__element"),r=document.querySelector("#housing-features"),a=document.querySelector(".ad-form");window.util.addShutdown([r,o,...t,...n],!0);const d=document.querySelector(".map__pin--main");document.querySelector("#address").value=window.util.findAdress(d),window.map={activateMap:()=>{window.util.addShutdown([r,o,...t,...n],!1),e.classList.remove("map--faded"),a.classList.remove("ad-form--disabled")}}})(),(()=>{const e=document.querySelector("#room_number"),t=document.querySelector("#capacity");e.value<t.value&&e.setCustomValidity(window.const.NOT_VALID_REPORT),e.addEventListener("change",(()=>{const o=Number(e.value),n=Number(t.value);2===o&&o<n?e.setCustomValidity(window.const.NOT_VALID_REPORT):100===o?t.value=0:0===n&&100!==o?t.setCustomValidity("Здесь нельзя разместить гостей"):t.setCustomValidity(""),e.setCustomValidity(n>o?window.const.NOT_VALID_REPORT:"")})),t.addEventListener("change",(()=>{const o=Number(e.value),n=Number(t.value);let r="";n>o?r=window.const.NOT_VALID_REPORT:100===o&&0!==n&&(r="Выбранное количество комнат не для гостей"),""===r&&e.setCustomValidity(""),t.setCustomValidity(r)}));const o=document.querySelector("#type"),n=document.querySelector("#price"),r=(e,t)=>{const o=Number(e.value);"flat"===t&&o<1e3?e.setCustomValidity("Минимальная цена для квартиры составляет 1000"):"house"===t&&o<5e3?e.setCustomValidity("Минимальная цена для дома составляет 5000"):"palace"===t&&o<1e4?e.setCustomValidity("Минимальная цена для дворца составляет 10000"):e.setCustomValidity("")};o.addEventListener("change",(()=>{"bungalo"===o.value?n.placeholder=0:"flat"===o.value?n.placeholder=1e3:"house"===o.value?n.placeholder=5e3:"palace"===o.value&&(n.placeholder=1e4),r(n,o.value)})),n.addEventListener("change",(()=>{r(n,o.value)}));const a=document.querySelector("#timein"),d=document.querySelector("#timeout");a.addEventListener("change",(()=>{d.value=a.value})),d.addEventListener("change",(()=>{a.value=d.value}));const c=document.querySelector(".ad-form"),u=document.querySelector(".map__pin--main"),l=document.querySelector(".ad-form__reset"),s=document.querySelector("#address"),i=document.querySelectorAll(".map__filter"),p=document.querySelector(".ad-form-header"),m=document.querySelectorAll(".ad-form__element"),y=document.querySelector("#housing-features"),f=document.querySelector(".map"),v=()=>{window.util.addShutdown([y,p,...i,...m],!0),f.classList.add("map--faded"),c.reset(),window.pin.deleteMarks();const e=document.querySelector(".map__card");e&&e.remove(),c.classList.add("ad-form--disabled")},w=e=>{e.preventDefault(),v(),u.style.left="570px",u.style.top="375px",s.value=window.util.findAdress(u),l.removeEventListener("click",w),u.addEventListener("click",window.main.onMainButtonClick)};l.addEventListener("click",w),window.form={reboot:v}})(),window.load=(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${o.timeout}мс`)})),o.timeout=1e4,o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},(()=>{const e=document.querySelector(".map__pin--main");e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const n=document.querySelector("#address");n.value=window.util.findAdress(e);const r=t=>{t.preventDefault();const r=o.x-t.clientX,a=o.y-t.clientY;o={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-a+"px",e.style.left=e.offsetLeft-r+"px";const d=parseInt(e.style.left,10),c=parseInt(e.style.top,10);d<=-33?e.style.left="-33px":d>=1167&&(e.style.left="1167px"),c<=65?e.style.top="65px":c>=630&&(e.style.top="630px"),n.value=window.util.findAdress(e)},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)}))})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),n=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),a=e.querySelector("#housing-features"),d="10000",c="50000";e.addEventListener("change",window.debounce((()=>{const e=document.querySelector(".map__card");e&&e.remove();const u=window.main.arrayAdverts.filter((e=>{return s=e.offer.type,("any"===t.value||t.value===s)&&(e=>{let t=!0;if("any"!==o.value)switch(o.value){case"low":t=e<d;break;case"middle":t=e>d&&e<c;break;case"high":t=e>c}return t})(e.offer.price)&&(l=e.offer.rooms,"any"===n.value||parseInt(n.value,10)===l)&&(u=e.offer.guests,"any"===r.value||parseInt(r.value,10)===u)&&(e=>{const t=a.querySelectorAll("input:checked");for(let o of t)if(-1===e.indexOf(o.value))return!1;return!0})(e.offer.features);var u,l,s}));window.pin.deleteMarks(),window.pin.renderPins(u.slice(0,5))})))})(),(()=>{const e=document.querySelector(".map__pin--main"),t=()=>{window.map.activateMap(),window.load((e=>{window.pin.renderPins(e),window.main.arrayAdverts=e})),e.removeEventListener("click",t)},o=document.querySelector(".ad-form");o.addEventListener("submit",(n=>{window.upload(new FormData(o),(()=>{window.form.reboot(),e.addEventListener("click",t)})),n.preventDefault()})),e.addEventListener("click",t),window.main={onMainButtonClick:t}})()})();