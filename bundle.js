(()=>{"use strict";window.const={NOT_VALID_REPORT:"Количество гостей больше, чем количество комнат",MOUSE_BUTTON:1,MIN_PRICE:"10000",MAX_PRICE:"50000",MAX_RENDERING_ADVERTS:5,Price:{BUNGALO:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},CoordStart:{X:570,Y:375},FILE_TYPES:["gif","jpg","jpeg","png"],STATUS_OK:200,PinSize:{X_HALF:33,Y:65,Y_ACTIVATE:22},StopeMove:{X_MIN:0,X_MAX:1200,Y_MIN:130,Y_MAX:565}},window.util={makeElement:(e,t)=>{const o=document.createElement(e);return o.classList.add(t),o},findAdress:e=>{let t="";return t=document.querySelector(".map").classList.contains("map--faded")?`${parseInt(e.style.left,10)+window.const.PinSize.X_HALF}, ${parseInt(e.style.top,10)+window.const.PinSize.Y}`:`${parseInt(e.style.left,10)+window.const.PinSize.X_HALF}, ${parseInt(e.style.top,10)+window.const.PinSize.Y+window.const.PinSize.Y_ACTIVATE}`,t},addShutdown:(e,t)=>{e.forEach((e=>{e.disabled=t}))}},window.debounce=e=>{let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector(".map__pins");window.upload=(n,r)=>{const d=new XMLHttpRequest;d.responseType="json";const i=e=>{e.remove()};d.addEventListener("load",(()=>{if(r(d.response),d.status===window.const.STATUS_OK){const t=e.cloneNode(!0);o.appendChild(t),t.addEventListener("click",(()=>{i(t)})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),i(t))}))}else{const e=t.cloneNode(!0);o.appendChild(e),e.addEventListener("click",(()=>{i(e)})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&(t.preventDefault(),i(e))}))}})),d.open("POST","https://21.javascript.pages.academy/keksobooking"),d.send(n)}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__filters-container"),o=document.querySelector(".map"),n=n=>{const r=e.cloneNode(!0);return r.querySelector("img").src=n.author.avatar,r.querySelector("img").alt=n.offer.title,r.style.left=n.location.x+"px",r.style.top=n.location.y+"px",r.addEventListener("click",(function(){o.insertBefore(window.advert.renderPopup(n),t)})),r};window.pin={mapList:o,filterCont:t,renderMark:n,deleteMarks:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove()))},renderMarks:e=>{const t=document.createDocumentFragment(),o=document.querySelector(".map__pins"),r=e.length>=window.const.MAX_RENDERING_ADVERTS?window.const.MAX_RENDERING_ADVERTS:e.length;for(let o=0;o<r;o++)t.appendChild(n(e[o]));o.appendChild(t)}}})(),(()=>{const e={BUNGALO:"bungalo",FLAT:"flat",HOUSE:"house",PALACE:"palace"},t=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector("#popup__img").content.querySelector(".popup__photo");window.advert={renderPopup:n=>{const r=t.cloneNode(!0),d=r.querySelector(".popup__photos"),i=document.querySelector(".map__card");i&&i.remove(),r.querySelector(".popup__avatar").src=n.author.avatar,r.querySelector(".popup__title").alt=n.offer.title,r.querySelector(".popup__text--address").textContent=n.offer.address,r.querySelector(".popup__text--price").textContent=`${n.offer.price} ₽/ночь`,n.offer.type===e.PALACE?r.querySelector(".popup__type").textContent="Дворец":n.offer.type===e.FLAT?r.querySelector(".popup__type").textContent="Квартира":n.offer.type===e.BUNGALO?r.querySelector(".popup__type").textContent="Бунгало":n.offer.type===e.HOUSE&&(r.querySelector(".popup__type").textContent="Дом"),r.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,r.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, и выезд до ${n.offer.checkout}`;const c=r.querySelector(".popup__features");return r.querySelectorAll(".popup__feature").forEach((e=>e.parentNode.removeChild(e))),n.offer.features.forEach((e=>{const t=window.util.makeElement("li","popup__feature");t.classList.add(`popup__feature--${e}`),c.appendChild(t)})),r.querySelector(".popup__description").textContent=n.offer.desccription,n.offer.photos.forEach((e=>{const t=o.cloneNode(!0);t.src=e,d.appendChild(t)})),r.querySelector(".popup__close").addEventListener("click",(function(){r.remove()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),r.remove())})),r},PopupType:e}})(),(()=>{const e=document.querySelectorAll(".map__filter"),t=document.querySelector(".ad-form-header"),o=document.querySelectorAll(".ad-form__element"),n=document.querySelector("#housing-features");window.util.addShutdown([n,t,...e,...o],!0),window.map={activatePage:r=>{window.util.addShutdown([n,t,...e,...o],!1),window.pin.mapList.classList.remove("map--faded"),window.main.form.classList.remove("ad-form--disabled"),window.form.address.value=window.util.findAdress(r)},filters:e,formHeader:t,formElements:o,houseFeature:n}})(),(()=>{const e=document.querySelector("#room_number"),t=document.querySelector("#capacity");e.value<t.value&&e.setCustomValidity(window.const.NOT_VALID_REPORT);const o=()=>{const o=Number(e.value),n=Number(t.value);let r="";2===o&&o<n?r=window.const.NOT_VALID_REPORT:0===n&&100!==o?r="Здесь нельзя разместить гостей":n>o?r=window.const.NOT_VALID_REPORT:100===o&&0!==n&&(r="Выбранное количество комнат не для гостей"),e.setCustomValidity(r)};e.addEventListener("change",(()=>{o()})),t.addEventListener("change",(()=>{o()}));const n=document.querySelector("#type"),r=document.querySelector("#price"),d=(e,t)=>{const o=Number(e.value);t===window.advert.FLAT&&o<window.const.Price.FLAT?e.setCustomValidity("Минимальная цена для квартиры составляет 1000"):t===window.advert.HOUSE&&o<window.const.Price.HOUSE?e.setCustomValidity("Минимальная цена для дома составляет 5000"):t===window.advert.PALACE&&o<window.const.Price.PALACE?e.setCustomValidity("Минимальная цена для дворца составляет 10000"):e.setCustomValidity("")};n.addEventListener("change",(()=>{n.value===window.advert.BUNGALO?r.placeholder=window.const.Price.BUNGALO:n.value===window.advert.FLAT?r.placeholder=window.const.Price.FLAT:n.value===window.advert.HOUSE?r.placeholder=window.const.Price.HOUSE:n.value===window.advert.PALACE&&(r.placeholder=window.const.Price.PALACE),d(r,n.value)})),r.addEventListener("change",(()=>{d(r,n.value)}));const i=document.querySelector("#timein"),c=document.querySelector("#timeout");i.addEventListener("change",(()=>{c.value=i.value})),c.addEventListener("change",(()=>{i.value=c.value}));const s=document.querySelector(".ad-form__reset"),a=document.querySelector("#avatar"),u=document.querySelector("#avatar__preview"),l=document.querySelector("#images"),p=document.querySelector(".ad-form__photo"),w=(e,t)=>{e.addEventListener("change",(()=>{const o=e.files[0],n=o.name.toLowerCase();if(window.const.FILE_TYPES.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{if(t.matches(".ad-form__photo")){const o=document.createElement("img");t.appendChild(o),o.src=e.result,o.classList.add("new-img")}else t.src=e.result})),e.readAsDataURL(o)}}))};w(a,u),w(l,p);const m=()=>{window.util.addShutdown([window.map.houseFeature,window.map.formHeader,...window.map.filters,...window.map.formElements],!0),window.pin.mapList.classList.add("map--faded"),window.main.form.reset(),window.pin.deleteMarks(),window.main.keyButton.style.left=`${window.const.CoordStart.X}px`,window.main.keyButton.style.top=`${window.const.CoordStart.Y}px`,u.src="img/muffin-grey.svg",document.querySelector(".new-img").remove();const e=document.querySelector(".map__card");e&&e.remove(),window.main.form.classList.add("ad-form--disabled")},f=document.querySelector("#address"),y=e=>{e.preventDefault(),m(),f.value=window.util.findAdress(window.main.keyButton),s.removeEventListener("click",y),window.main.keyButton.addEventListener("click",window.main.onKeyButtonClick)};s.addEventListener("click",y),window.form={reboot:m,address:f}})(),window.load=(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${o.timeout}мс`)})),o.timeout=1e4,o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},(()=>{const e=document.querySelector(".map__pin--main");e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const n=document.querySelector("#address");n.value=window.util.findAdress(e);const r=t=>{t.preventDefault();const r=o.x-t.clientX,d=o.y-t.clientY;o={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-d+"px",e.style.left=e.offsetLeft-r+"px";const i=parseInt(e.style.left,10),c=parseInt(e.style.top,10);i<=window.const.StopeMove.X_MIN-window.const.PinSize.X_HALF?e.style.left=window.const.StopeMove.X_MIN-window.const.PinSize.X_HALF+"px":i>=window.const.StopeMove.X_MAX-window.const.PinSize.X_HALF&&(e.style.left=window.const.StopeMove.X_MAX-window.const.PinSize.X_HALF+"px"),c<=window.const.StopeMove.Y_MIN-window.const.PinSize.Y?e.style.top=window.const.StopeMove.Y_MIN-window.const.PinSize.Y+"px":c>=window.const.StopeMove.Y_MAX&&(e.style.top=`${window.const.StopeMove.Y_MAX}px`),n.value=window.util.findAdress(e)},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",d)}))})(),(()=>{const e="any",t=document.querySelector(".map__filters-container"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),d=t.querySelector("#housing-guests"),i=t.querySelector("#housing-features"),c=t=>{let o=!0;if(n.value!==e)switch(n.value){case"low":o=t<window.const.MIN_PRICE;break;case"middle":o=t>window.const.MIN_PRICE&&t<window.const.MAX_PRICE;break;case"high":o=t>window.const.MAX_PRICE}return o},s=e=>{const t=i.querySelectorAll("input:checked");for(let o of t)if(-1===e.indexOf(o.value))return!1;return!0};t.addEventListener("change",window.debounce((()=>{const t=document.querySelector(".map__card");t&&t.remove();const n=[];for(let t of window.main.arrayAdverts)if(u=t.offer.type,(o.value===e||o.value===u)&&c(t.offer.price)&&(a=t.offer.rooms,r.value===e||parseInt(r.value,10)===a)&&(i=t.offer.guests,d.value===e||parseInt(d.value,10)===i)&&s(t.offer.features)&&n.push(t),n.length===window.const.MAX_RENDERING_ADVERTS)break;var i,a,u;window.pin.deleteMarks(),window.pin.renderMarks(n)})))})(),(()=>{const e=document.querySelector(".map__pin--main");window.form.address.value=window.util.findAdress(e);const t=()=>{window.map.activatePage(e),window.load((e=>{window.pin.renderMarks(e),window.main.arrayAdverts=e})),e.removeEventListener("click",t)},o=document.querySelector(".ad-form");o.addEventListener("submit",(n=>{window.upload(new FormData(o),(()=>{window.form.reboot(),e.addEventListener("click",t)})),n.preventDefault()})),e.addEventListener("click",t),window.main={onKeyButtonClick:t,keyButton:e,form:o}})()})();